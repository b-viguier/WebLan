<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebLan - Motion</title>

    <script src="https://code.createjs.com/easeljs-0.8.1.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.1.min.js"></script>

    <script>
        function init() {

            var conn = new WebSocket('ws://localhost:8080');

            var canvas = document.getElementById("mainCanvas");
            var stage = new createjs.Stage(canvas);

            var circle = new createjs.Shape();
            circle.graphics.beginFill("DeepSkyBlue").drawCircle(0, 0, 50);

            circle.x = Math.random() * canvas.width;
            circle.y = Math.random() * canvas.height;
            circle.velX = Math.random() * 10 + 5;
            circle.velY = Math.random() * 10 + 5;

            stage.addChild(circle);

            createjs.Ticker.timingMode = createjs.Ticker.RAF;
            createjs.Ticker.addEventListener("tick", tick);

            createjs.Ticker.setFPS(60);

            var otherCircles = {};

            conn.onmessage = function(e) {

                var data = JSON.parse(e.data);
                if(data.header.type == 'CONNECT') {
                    createOtherCircle(data.header.sender);
                } else if (data.header.type == 'OTHERS') {
                    for(var index = 0, length = data.body.others.length; index < length; ++index) {
                        createOtherCircle(data.body.others[index]);
                    }
                } else if (data.header.type == 'POSITION') {
                    var other = otherCircles[data.header.sender];
                    other.x = data.body.x;
                    other.y = data.body.y;
                    other.velX = data.body.velX;
                    other.velY = data.body.velY;
                }

                function createOtherCircle(id) {
                    var newCircle = new createjs.Shape();
                    newCircle.graphics.beginFill("Red").drawCircle(0, 0, 50);
                    otherCircles[id] = newCircle;
                    stage.addChild(newCircle);
                }
                //TODO: manage DISCONNECTED
            };

            function tick(event) {

                circle.x = circle.x + circle.velX;
                circle.y = circle.y + circle.velY;


                if( circle.x < 0) {
                    circle.velX = - circle.velX;
                    circle.x = - circle.x;
                } else if(circle.x > canvas.width ) {
                    circle.velX = -circle.velX;
                    circle.x = 2*canvas.width - circle.x;
                }
                if( circle.y < 0) {
                    circle.velY = - circle.velY;
                    circle.y = - circle.y;
                } else if(circle.y > canvas.height ) {
                    circle.velY = -circle.velY;
                    circle.y = 2*canvas.height - circle.y;
                }

                //Send new position
                conn.send( JSON.stringify({
                    "header": {
                        "type": "POSITION",
                        "receiver": "@all"
                    },
                    "body": {
                        "x": circle.x,
                        "y": circle.y,
                        "velX": circle.velX,
                        "velY": circle.velY
                    }
                }));

                stage.update(event);
            }
        }


    </script>

</head>
<body onload="init();">
    <canvas id="mainCanvas" width="1000" height="500"></canvas>
</body>
</html>